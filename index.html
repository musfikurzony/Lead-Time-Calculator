<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dynamic Lead Time Calculator</title>
<style>
  body { font-family: Inter, Arial, sans-serif; background:#f4f7fb; margin:0; padding:22px; color:#0b1a2b }
  h1{margin:0 0 12px}
  .section { background:#fff; padding:16px; border-radius:10px; margin-bottom:16px; box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .btn { padding:8px 12px; border:none; border-radius:8px; background:#0ea5a4; color:#fff; cursor:pointer }
  .ghost{background:transparent;color:#0ea5a4;border:1px solid #c7f0ea}
  .smallBtn{padding:6px 8px;background:#e6eef2;border-radius:6px;border:none;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6eef2;padding:8px;text-align:center;font-size:13px}
  th{background:#f0f9ff;color:#0b3954}
  .row{display:flex;gap:8px;align-items:center}
  input[type=date], input[type=text], input[type=number]{padding:8px;border:1px solid #e6eef2;border-radius:6px}
  .footer{ text-align:center;margin-top:20px;font-size:12px;font-style:italic;color:#6e6e6e }
  details summary{list-style:none; cursor:pointer}
</style>
</head>
<body>

<h1>Dynamic Lead Time Calculator</h1>

<!-- SETTINGS (collapsed) -->
<details class="section" id="settingsPanel">
  <summary class="btn">Settings (click to open)</summary>
  <div style="margin-top:12px">
    <h3>Durations (days)</h3>
    <div class="row" style="gap:12px;flex-wrap:wrap;">
      <label>Order → Fabric ETD <input id="s_d1" type="number" value="60" style="width:90px"></label>
      <label>Fabric ETD → Inhouse <input id="s_d2" type="number" value="30" style="width:90px"></label>
      <label>Inhouse → Prod End <input id="s_d3" type="number" value="45" style="width:90px"></label>
      <label>ETD → ETA <input id="s_d4" type="number" value="60" style="width:90px"></label>
      <label>ETA → CDD <input id="s_d5" type="number" value="14" style="width:90px"></label>
    </div>

    <h3 style="margin-top:12px">Holiday Settings</h3>
    <div id="holidayArea"></div>
    <div style="margin-top:8px"><button id="addHoliday" class="smallBtn">+ Add Holiday</button></div>

    <h3 style="margin-top:12px">Seasons (CDD)</h3>
    <div id="seasonArea"></div>
    <div style="margin-top:8px"><button id="addSeason" class="smallBtn">+ Add Season</button></div>

    <div style="margin-top:12px"><button id="saveSettings" class="btn">Save Settings</button></div>

    <p style="margin-top:10px;font-size:13px;color:#475569">Notes: Orders Due (Mon-Fri). Fabric in-house (Sun-Thu). ETD ex-BD — Sunday vessels. Holidays will impact relevant steps.</p>
  </div>
</details>

<!-- BACKWARD PLANNING -->
<div class="section">
  <h2>Backward Planning (Input: CDD per season)</h2>
  <div><button id="calcBackward" class="btn">Calculate Backward</button></div>
  <div id="backwardChart" style="margin-top:12px"></div>
</div>

<!-- FORWARD PLANNING -->
<div class="section">
  <h2>Forward Planning (Inline editable Order Due in each row)</h2>
  <div id="forwardChart"></div>
</div>

<footer class="footer">Calculator developed by Musfikur Rahman – Perry Ellis Bangladesh | Copyright © 2025.</footer>

<script>
// Run after DOM ready
(function(){
  // Utilities
  const el = (id)=>document.getElementById(id);
  function fmt(d){ if(!d) return ''; if(typeof d==='string') d=new Date(d+'T00:00:00'); if(!(d instanceof Date)) return ''; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` }
  function parseDateISO(s){ return s? new Date(s+'T00:00:00'): null }
  function addDays(d,n){ const x = new Date(d); x.setDate(x.getDate()+n); return x }
  function adjustToMonFri(d){ const dt=new Date(d); while(dt.getDay()===0 || dt.getDay()===6) dt.setDate(dt.getDate()+1); return dt }
  function adjustToSunThu(d){ const dt=new Date(d); while(dt.getDay()>4) dt.setDate(dt.getDate()+1); return dt }
  function adjustToNextSunday(d){ const dt=new Date(d); const daysAhead = (7 - dt.getDay())%7; dt.setDate(dt.getDate()+daysAhead); return dt }

  // Default data
  let settings = {
    durations:{d1:60,d2:30,d3:45,d4:60,d5:14},
    holidays:[
      {name:'1st Eid 2026', from:'2026-03-18', to:'2026-03-29'},
      {name:'2nd Eid 2026', from:'2026-05-23', to:'2026-05-31'},
      {name:'CNY 2026', from:'2026-02-03', to:'2026-03-03'}
    ],
    seasons:[
      {name:'SPRING 2026', cdd:'2026-01-25'},
      {name:'SUMMER 2026', cdd:'2026-04-25'},
      {name:'FALL 2026', cdd:'2026-07-25'},
      {name:'HOLIDAY 2026', cdd:'2026-10-25'}
    ]
  };

  // Forward rows (scenarios)
  let forwardRows = [ {name:'Scenario A', due:'2025-11-20'}, {name:'Scenario B', due:'2025-11-27'} ];

  // Renderers
  function renderHolidaySettings(){
    const area = el('holidayArea'); area.innerHTML='';
    settings.holidays.forEach((h,i)=>{
      const row = document.createElement('div'); row.className='row';
      const inputName = document.createElement('input'); inputName.type='text'; inputName.value=h.name; inputName.onchange=(e)=>settings.holidays[i].name=e.target.value;
      const inputFrom = document.createElement('input'); inputFrom.type='date'; inputFrom.value=h.from; inputFrom.onchange=(e)=>settings.holidays[i].from=e.target.value;
      const inputTo = document.createElement('input'); inputTo.type='date'; inputTo.value=h.to; inputTo.onchange=(e)=>settings.holidays[i].to=e.target.value;
      const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Delete'; del.onclick=()=>{settings.holidays.splice(i,1); renderHolidaySettings();};
      row.appendChild(inputName); row.appendChild(inputFrom); row.appendChild(inputTo); row.appendChild(del);
      area.appendChild(row);
    });
  }

  function renderSeasonSettings(){
    const area = el('seasonArea'); area.innerHTML='';
    settings.seasons.forEach((s,i)=>{
      const row = document.createElement('div'); row.className='row';
      const inputName = document.createElement('input'); inputName.type='text'; inputName.value=s.name; inputName.onchange=(e)=>settings.seasons[i].name=e.target.value;
      const inputCDD = document.createElement('input'); inputCDD.type='date'; inputCDD.value=s.cdd; inputCDD.onchange=(e)=>{settings.seasons[i].cdd=e.target.value};
      const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Delete'; del.onclick=()=>{settings.seasons.splice(i,1); renderSeasonSettings(); renderBackwardTable();};
      row.appendChild(inputName); row.appendChild(inputCDD); row.appendChild(del);
      area.appendChild(row);
    });
  }

  // Calculation helpers using holiday awareness (simple overlap additions)
  function overlapDays(rangeStart, rangeEnd, hol){
    const s = new Date(rangeStart); const e = new Date(rangeEnd);
    const hs = new Date(hol.from+'T00:00:00'); const he = new Date(hol.to+'T00:00:00');
    const start = s>hs? s : hs; const end = e<he? e: he; if(end < start) return 0; return Math.round((end-start)/(24*3600*1000))+1;
  }

  function applyChinaHolidayAdjustment(startDate, duration){
    // if period [startDate, startDate+duration] overlaps china holidays (CNY/Oct), add overlap to start earlier (backward) or extend (forward)
    return 0; // placeholder for more advanced adjustments — keep zero for now
  }

  // Backward table (inline)
  function renderBackwardTable(){
    const out = el('backwardChart');
    let html = `<table><thead><tr><th>Season</th><th>CDD</th><th>ETA (USA)</th><th>ETD ex-BD</th><th>Fabric In-house</th><th>Fabric ETD</th><th>Order Due</th></tr></thead><tbody>`;
    settings.seasons.forEach(s=>{
      if(!s.cdd) return;
      const cdd = parseDateISO(s.cdd);
      const eta = addDays(cdd, -settings.durations?.d5 ?? -14);
      let etdBase = addDays(eta, -settings.durations?.d4 ?? -60);
      // production: in-house -> prod end
      let fabIn = addDays(etdBase, -settings.durations?.d3 ?? -45);
      // ensure fabIn falls Sun-Thu
      fabIn = adjustToSunThu(fabIn);
      let fabETD = addDays(fabIn, -settings.durations?.d2 ?? -30);
      let ordersDue = addDays(fabETD, -settings.durations?.d1 ?? -60);
      ordersDue = adjustToMonFri(ordersDue);
      const etdEx = adjustToNextSunday(etdBase);
      html += `<tr><td>${s.name}</td><td>${fmt(cdd)}</td><td>${fmt(eta)}</td><td>${fmt(etdEx)}</td><td>${fmt(fabIn)}</td><td>${fmt(fabETD)}</td><td>${fmt(ordersDue)}</td></tr>`;
    });
    html += `</tbody></table>`;
    out.innerHTML = html;
  }

  // Forward table with inline date inputs per row
  function renderForwardTable(){
    const out = el('forwardChart');
    let html = `<table><thead><tr><th>Scenario</th><th>Order Due (edit)</th><th>Fabric ETD</th><th>Fabric In-house</th><th>ETD ex-BD</th><th>ETA</th><th>CDD</th><th>Action</th></tr></thead><tbody>`;
    forwardRows.forEach((r,i)=>{
      html += `<tr data-i='${i}'>
        <td><input type='text' class='fName' data-i='${i}' value='${r.name}' style='width:120px'></td>
        <td><input type='date' class='fDue' data-i='${i}' value='${r.due||''}'></td>
        <td class='fabETD'>-</td>
        <td class='fabIn'>-</td>
        <td class='etdEx'>-</td>
        <td class='eta'>-</td>
        <td class='cdd'>-</td>
        <td><button class='smallBtn delRow' data-i='${i}'>Delete</button></td>
      </tr>`;
    });
    html += `</tbody></table><div style='margin-top:8px'><button id='addForwardRow' class='btn'>+ Add Scenario</button></div>`;
    out.innerHTML = html;

    // attach events
    out.querySelectorAll('.fDue').forEach(inp=>{
      inp.addEventListener('change', (e)=>{
        const i = Number(e.target.dataset.i); forwardRows[i].due = e.target.value; computeFillForwardRow(i);
      });
    });
    out.querySelectorAll('.fName').forEach(inp=>{ inp.addEventListener('change',(e)=>{ forwardRows[Number(e.target.dataset.i)].name = e.target.value; }); });
    out.querySelectorAll('.delRow').forEach(b=>{ b.addEventListener('click', (e)=>{ const i=Number(e.target.dataset.i); forwardRows.splice(i,1); renderForwardTable(); }); });
    const addBtn = el('addForwardRow'); if(addBtn) addBtn.onclick = ()=>{ forwardRows.push({name:'New', due:''}); renderForwardTable(); };

    // fill computed values
    forwardRows.forEach((r, i)=> computeFillForwardRow(i));
  }

  function computeFillForwardRow(i){
    const row = document.querySelector(`tr[data-i="${i}"]`);
    if(!row) return;
    const r = forwardRows[i];
    const due = r.due ? parseDateISO(r.due) : null;
    if(!due){ row.querySelector('.fabETD').textContent=''; row.querySelector('.fabIn').textContent=''; row.querySelector('.etdEx').textContent=''; row.querySelector('.eta').textContent=''; row.querySelector('.cdd').textContent=''; return; }

    // Apply business day constraints and durations
    const d1 = Number(el('s_d1').value || settings.durations.d1);
    const d2 = Number(el('s_d2').value || settings.durations.d2);
    const d3 = Number(el('s_d3').value || settings.durations.d3);
    const d4 = Number(el('s_d4').value || settings.durations.d4);
    const d5 = Number(el('s_d5').value || settings.durations.d5);

    let ordersDue = adjustToMonFri(due);
    let fabETD = addDays(ordersDue, d1);
    // if fabETD overlaps China holiday (simplified: CNY), push forward by overlap days
    const chinaHols = settings.holidays.filter(h=>/CNY|China|Oct|October/i.test(h.name));
    // (we keep adjustment simple — can be refined)
    let fabIn = addDays(fabETD, d2);
    fabIn = adjustToSunThu(fabIn);
    let prodEnd = addDays(fabIn, d3);
    // if prod overlaps Eid holidays, push prodEnd forward
    const eidHols = settings.holidays.filter(h=>/Eid/i.test(h.name));
    // simple overlap handling — count overlap days and extend
    let extra=0; eidHols.forEach(h=>{ const ov = overlapDays(addDays(fabIn,0), prodEnd, h); if(ov>0) extra += ov; });
    if(extra>0) { prodEnd = addDays(prodEnd, extra); }
    let etdEx = adjustToNextSunday(prodEnd);
    let eta = addDays(etdEx, d4);
    let cdd = addDays(eta, d5);

    row.querySelector('.fabETD').textContent = fmt(fabETD);
    row.querySelector('.fabIn').textContent = fmt(fabIn);
    row.querySelector('.etdEx').textContent = fmt(etdEx);
    row.querySelector('.eta').textContent = fmt(eta);
    row.querySelector('.cdd').textContent = fmt(cdd);
  }

  // Wire up buttons and initial render
  function wireUI(){
    el('addHoliday').onclick = ()=>{ settings.holidays.push({name:'New Holiday', from:'2026-01-01', to:'2026-01-02'}); renderHolidaySettings(); };
    el('addSeason').onclick = ()=>{ settings.seasons.push({name:'NEW SEASON', cdd:''}); renderSeasonSettings(); };
    el('saveSettings').onclick = ()=>{
      // update durations
      settings.durations.d1 = Number(el('s_d1').value);
      settings.durations.d2 = Number(el('s_d2').value);
      settings.durations.d3 = Number(el('s_d3').value);
      settings.durations.d4 = Number(el('s_d4').value);
      settings.durations.d5 = Number(el('s_d5').value);
      // read season/holiday inputs are already bound in renderers
      alert('Settings saved'); renderBackwardTable(); renderForwardTable();
    };
    el('calcBackward').onclick = renderBackwardTable;
  }

  // Initial render
  function init(){
    // populate settings inputs
    el('s_d1').value = settings.durations.d1;
    el('s_d2').value = settings.durations.d2;
    el('s_d3').value = settings.durations.d3;
    el('s_d4').value = settings.durations.d4;
    el('s_d5').value = settings.durations.d5;

    renderHolidaySettings(); renderSeasonSettings(); renderBackwardTable(); renderForwardTable(); wireUI();
  }

  // kick off
  init();
})();
</script>
</body>
</html>
